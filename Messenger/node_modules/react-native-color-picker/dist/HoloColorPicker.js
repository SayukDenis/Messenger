var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
import React from "react";
import { I18nManager, Image, InteractionManager, Slider, StyleSheet, TouchableOpacity, View, } from "react-native";
import tinycolor from "tinycolor2";
import { createPanResponder } from "./utils";
var HoloColorPicker = /** @class */ (function (_super) {
    __extends(HoloColorPicker, _super);
    function HoloColorPicker(props, ctx) {
        var _this = _super.call(this, props, ctx) || this;
        _this._handleColorChange = function (_a) {
            var x = _a.x, y = _a.y;
            var _b = _this._getColor(), s = _b.s, v = _b.v;
            var marginLeft = (_this._layout.width - _this.state.pickerSize) / 2;
            var marginTop = (_this._layout.height - _this.state.pickerSize) / 2;
            var relativeX = x - _this._pageX - marginLeft;
            var relativeY = y - _this._pageY - marginTop;
            var h = _this._computeHValue(relativeX, relativeY);
            _this._onColorChange({ h: h, s: s, v: v });
            return true;
        };
        var state = {
            color: { h: 0, s: 1, v: 1 },
            pickerSize: null,
        };
        if (props.oldColor) {
            state.color = tinycolor(props.oldColor).toHsv();
        }
        if (props.defaultColor) {
            state.color = tinycolor(props.defaultColor).toHsv();
        }
        _this.state = state;
        _this._layout = { width: 0, height: 0, x: 0, y: 0 };
        _this._pageX = 0;
        _this._pageY = 0;
        _this._onLayout = _this._onLayout.bind(_this);
        _this._onSValueChange = _this._onSValueChange.bind(_this);
        _this._onVValueChange = _this._onVValueChange.bind(_this);
        _this._onColorSelected = _this._onColorSelected.bind(_this);
        _this._onOldColorSelected = _this._onOldColorSelected.bind(_this);
        _this._isRTL = I18nManager.isRTL;
        _this._pickerResponder = createPanResponder({
            onStart: _this._handleColorChange,
            onMove: _this._handleColorChange,
        });
        return _this;
    }
    HoloColorPicker.prototype._getColor = function () {
        var passedColor = typeof this.props.color === "string"
            ? tinycolor(this.props.color).toHsv()
            : this.props.color;
        return passedColor || this.state.color;
    };
    HoloColorPicker.prototype._onColorSelected = function () {
        var onColorSelected = this.props.onColorSelected;
        var color = tinycolor(this._getColor()).toHexString();
        onColorSelected && onColorSelected(color);
    };
    HoloColorPicker.prototype._onOldColorSelected = function () {
        var _a = this.props, oldColor = _a.oldColor, onOldColorSelected = _a.onOldColorSelected;
        var color = tinycolor(oldColor);
        this.setState({ color: color.toHsv() });
        onOldColorSelected && onOldColorSelected(color.toHexString());
    };
    HoloColorPicker.prototype._onSValueChange = function (s) {
        var _a = this._getColor(), h = _a.h, v = _a.v;
        this._onColorChange({ h: h, s: s, v: v });
    };
    HoloColorPicker.prototype._onVValueChange = function (v) {
        var _a = this._getColor(), h = _a.h, s = _a.s;
        this._onColorChange({ h: h, s: s, v: v });
    };
    HoloColorPicker.prototype._onColorChange = function (color) {
        this.setState({ color: color });
        if (this.props.onColorChange) {
            this.props.onColorChange(color);
        }
    };
    HoloColorPicker.prototype._onLayout = function (l) {
        var _this = this;
        this._layout = l.nativeEvent.layout;
        var _a = this._layout, width = _a.width, height = _a.height;
        var pickerSize = Math.min(width, height);
        if (this.state.pickerSize !== pickerSize) {
            this.setState({ pickerSize: pickerSize });
        }
        // layout.x, layout.y is always 0
        // we always measure because layout is the same even though picker is moved on the page
        InteractionManager.runAfterInteractions(function () {
            // measure only after (possible) animation ended
            _this.refs.pickerContainer &&
                _this.refs.pickerContainer.measure(function (x, y, width, height, pageX, pageY) {
                    // picker position in the screen
                    _this._pageX = pageX;
                    _this._pageY = pageY;
                });
        });
    };
    HoloColorPicker.prototype._computeHValue = function (x, y) {
        var mx = this.state.pickerSize / 2;
        var my = this.state.pickerSize / 2;
        var dx = x - mx;
        var dy = y - my;
        var rad = Math.atan2(dx, dy) + Math.PI + Math.PI / 2;
        return ((rad * 180) / Math.PI) % 360;
    };
    HoloColorPicker.prototype._hValueToRad = function (deg) {
        var rad = (deg * Math.PI) / 180;
        return rad - Math.PI - Math.PI / 2;
    };
    HoloColorPicker.prototype._getSlider = function () {
        if (this.props.hideSliders) {
            return undefined;
        }
        if (this.props.sliderComponent) {
            return this.props.sliderComponent;
        }
        if (!Slider) {
            throw new Error("You need to install `@react-native-community/slider` and pass it (or any other Slider compatible component) as `sliderComponent` prop");
        }
        return Slider;
    };
    HoloColorPicker.prototype.getColor = function () {
        return tinycolor(this._getColor()).toHexString();
    };
    HoloColorPicker.prototype.render = function () {
        var pickerSize = this.state.pickerSize;
        var _a = this.props, oldColor = _a.oldColor, style = _a.style;
        var color = this._getColor();
        var h = color.h, s = color.s, v = color.v;
        var angle = this._hValueToRad(h);
        var selectedColor = tinycolor(color).toHexString();
        var indicatorColor = tinycolor({ h: h, s: 1, v: 1 }).toHexString();
        var computed = makeComputedStyles({
            pickerSize: pickerSize,
            selectedColor: selectedColor,
            indicatorColor: indicatorColor,
            oldColor: oldColor,
            angle: angle,
            isRTL: this._isRTL,
        });
        var SliderComp = this._getSlider();
        return (<View style={style}>
        <View onLayout={this._onLayout} ref="pickerContainer" style={styles.pickerContainer}>
          {!pickerSize ? null : (<View>
              <View {...this._pickerResponder.panHandlers} style={[computed.picker]} collapsable={false}>
                <Image source={require("../resources/color-circle.png")} resizeMode="contain" style={[styles.pickerImage]}/>
                <View style={[styles.pickerIndicator, computed.pickerIndicator]}/>
              </View>
              {oldColor && (<TouchableOpacity style={[styles.selectedPreview, computed.selectedPreview]} onPress={this._onColorSelected} activeOpacity={0.7}/>)}
              {oldColor && (<TouchableOpacity style={[styles.originalPreview, computed.originalPreview]} onPress={this._onOldColorSelected} activeOpacity={0.7}/>)}
              {!oldColor && (<TouchableOpacity style={[
            styles.selectedFullPreview,
            computed.selectedFullPreview,
        ]} onPress={this._onColorSelected} activeOpacity={0.7}/>)}
            </View>)}
        </View>
        {this.props.hideSliders ? null : (<View>
            <SliderComp value={s} onValueChange={this._onSValueChange}/>
            <SliderComp value={v} onValueChange={this._onVValueChange}/>
          </View>)}
      </View>);
    };
    return HoloColorPicker;
}(React.PureComponent));
export { HoloColorPicker };
var makeComputedStyles = function (_a) {
    var _b;
    var indicatorColor = _a.indicatorColor, selectedColor = _a.selectedColor, oldColor = _a.oldColor, angle = _a.angle, pickerSize = _a.pickerSize, isRTL = _a.isRTL;
    var summarySize = 0.5 * pickerSize;
    var indicatorPickerRatio = 42 / 510; // computed from picker image
    var indicatorSize = indicatorPickerRatio * pickerSize;
    var pickerPadding = indicatorSize / 3;
    var indicatorRadius = pickerSize / 2 - indicatorSize / 2 - pickerPadding;
    var mx = pickerSize / 2;
    var my = pickerSize / 2;
    var dx = Math.cos(angle) * indicatorRadius;
    var dy = Math.sin(angle) * indicatorRadius;
    return {
        picker: {
            padding: pickerPadding,
            width: pickerSize,
            height: pickerSize,
        },
        pickerIndicator: (_b = {
                top: mx + dx - indicatorSize / 2
            },
            _b[isRTL ? "right" : "left"] = my + dy - indicatorSize / 2,
            _b.width = indicatorSize,
            _b.height = indicatorSize,
            _b.borderRadius = indicatorSize / 2,
            _b.backgroundColor = indicatorColor,
            _b),
        selectedPreview: {
            width: summarySize / 2,
            height: summarySize,
            top: pickerSize / 2 - summarySize / 2,
            left: Math.floor(pickerSize / 2),
            borderTopRightRadius: summarySize / 2,
            borderBottomRightRadius: summarySize / 2,
            backgroundColor: selectedColor,
        },
        originalPreview: {
            width: Math.ceil(summarySize / 2),
            height: summarySize,
            top: pickerSize / 2 - summarySize / 2,
            left: pickerSize / 2 - summarySize / 2,
            borderTopLeftRadius: summarySize / 2,
            borderBottomLeftRadius: summarySize / 2,
            backgroundColor: oldColor,
        },
        selectedFullPreview: {
            width: summarySize,
            height: summarySize,
            top: pickerSize / 2 - summarySize / 2,
            left: pickerSize / 2 - summarySize / 2,
            borderRadius: summarySize / 2,
            backgroundColor: selectedColor,
        },
    };
};
var styles = StyleSheet.create({
    pickerContainer: {
        flex: 1,
        alignItems: "center",
        justifyContent: "center",
    },
    pickerImage: {
        flex: 1,
        width: null,
        height: null,
    },
    pickerIndicator: {
        position: "absolute",
        // Shadow only works on iOS.
        shadowColor: "black",
        shadowOpacity: 0.3,
        shadowOffset: { width: 3, height: 3 },
        shadowRadius: 4,
        // This will elevate the view on Android, causing shadow to be drawn.
        elevation: 5,
    },
    selectedPreview: {
        position: "absolute",
        borderLeftWidth: 0,
    },
    originalPreview: {
        position: "absolute",
        borderRightWidth: 0,
    },
    selectedFullPreview: {
        position: "absolute",
    },
    pickerAlignment: {
        alignItems: "center",
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSG9sb0NvbG9yUGlja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0hvbG9Db2xvclBpY2tlci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLEVBQ0wsV0FBVyxFQUNYLEtBQUssRUFDTCxrQkFBa0IsRUFFbEIsTUFBTSxFQUNOLFVBQVUsRUFDVixnQkFBZ0IsRUFDaEIsSUFBSSxHQUNMLE1BQU0sY0FBYyxDQUFBO0FBQ3JCLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUdsQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFnQjVDO0lBQXFDLG1DQUdwQztJQU9DLHlCQUFZLEtBQXVCLEVBQUUsR0FBUTtRQUE3QyxZQUNFLGtCQUFNLEtBQUssRUFBRSxHQUFHLENBQUMsU0F5QmxCO1FBeUVELHdCQUFrQixHQUFHLFVBQUMsRUFBaUI7Z0JBQWYsQ0FBQyxPQUFBLEVBQUUsQ0FBQyxPQUFBO1lBQ3BCLElBQUEsS0FBVyxLQUFJLENBQUMsU0FBUyxFQUFFLEVBQXpCLENBQUMsT0FBQSxFQUFFLENBQUMsT0FBcUIsQ0FBQTtZQUNqQyxJQUFNLFVBQVUsR0FBRyxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLEtBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ25FLElBQU0sU0FBUyxHQUFHLENBQUMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsS0FBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDbkUsSUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFHLEtBQUksQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFBO1lBQzlDLElBQU0sU0FBUyxHQUFHLENBQUMsR0FBRyxLQUFJLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQTtZQUM3QyxJ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QUNuQixRQUFRLEVBQUUsVUFBVTtLQUNyQjtJQUNELGVBQWUsRUFBRTtRQUNmLFVBQVUsRUFBRSxRQUFRO0tBQ3JCO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiXG5pbXBvcnQge1xuICBJMThuTWFuYWdlcixcbiAgSW1hZ2UsXG4gIEludGVyYWN0aW9uTWFuYWdlcixcbiAgUGFuUmVzcG9uZGVySW5zdGFuY2UsXG4gIFNsaWRlcixcbiAgU3R5bGVTaGVldCxcbiAgVG91Y2hhYmxlT3BhY2l0eSxcbiAgVmlldyxcbn0gZnJvbSBcInJlYWN0LW5hdGl2ZVwiXG5pbXBvcnQgdGlueWNvbG9yIGZyb20gXCJ0aW55Y29sb3IyXCJcblxuaW1wb3J0IHsgSHN2Q29sb3IsIElQaWNrZXJQcm9wcywgUG9pbnQyRCB9IGZyb20gXCIuL3R5cGVIZWxwZXJzXCJcbmltcG9ydCB7IGNyZWF0ZVBhblJlc3BvbmRlciB9IGZyb20gXCIuL3V0aWxzXCJcblxudHlwZSBTbGlkZXJQcm9wcyA9IHtcbiAgb25WYWx1ZUNoYW5nZT86ICh2YWx1ZTogbnVtYmVyKSA9PiB2b2lkO1xuICB2YWx1ZT86IG51bWJlcjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUhvbG9QaWNrZXJQcm9wcyBleHRlbmRzIElQaWNrZXJQcm9wcyB7XG4gIHNsaWRlckNvbXBvbmVudD86IFJlYWN0LkNvbXBvbmVudDxTbGlkZXJQcm9wcz47XG59XG5cbmV4cG9ydCB0eXBlIElIb2xvUGlja2VyU3RhdGUgPSB7XG4gIGNvbG9yOiBIc3ZDb2xvcjtcbiAgcGlja2VyU2l6ZTogbnVtYmVyO1xufTtcblxuZXhwb3J0IGNsYXNzIEhvbG9Db2xvclBpY2tlciBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8XG4gIElIb2xvUGlja2VyUHJvcHMsXG4gIElIb2xvUGlja2VyU3RhdGVcbj4ge1xuICBwcml2YXRlIF9sYXlvdXQ6IHsgd2lkdGg6IG51bWJlcjsgaGVpZ2h0OiBudW1iZXI7IHg6IG51bWJlcjsgeTogbnVtYmVyIH07XG4gIHByaXZhdGUgX3BhZ2VYOiBudW1iZXI7XG4gIHByaXZhdGUgX3BhZ2VZOiBudW1iZXI7XG4gIHByaXZhdGUgX2lzUlRMOiBib29sZWFuO1xuICBwcml2YXRlIF9waWNrZXJSZXNwb25kZXI6IFBhblJlc3BvbmRlckluc3RhbmNlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBJSG9sb1BpY2tlclByb3BzLCBjdHg6IGFueSkge1xuICAgIHN1cGVyKHByb3BzLCBjdHgpXG4gICAgY29uc3Qgc3RhdGUgPSB7XG4gICAgICBjb2xvcjogeyBoOiAwLCBzOiAxLCB2OiAxIH0sXG4gICAgICBwaWNrZXJTaXplOiBudWxsLFxuICAgIH1cbiAgICBpZiAocHJvcHMub2xkQ29sb3IpIHtcbiAgICAgIHN0YXRlLmNvbG9yID0gdGlueWNvbG9yKHByb3BzLm9sZENvbG9yKS50b0hzdigpXG4gICAgfVxuICAgIGlmIChwcm9wcy5kZWZhdWx0Q29sb3IpIHtcbiAgICAgIHN0YXRlLmNvbG9yID0gdGlueWNvbG9yKHByb3BzLmRlZmF1bHRDb2xvcikudG9Ic3YoKVxuICAgIH1cbiAgICB0aGlzLnN0YXRlID0gc3RhdGVcbiAgICB0aGlzLl9sYXlvdXQgPSB7IHdpZHRoOiAwLCBoZWlnaHQ6IDAsIHg6IDAsIHk6IDAgfVxuICAgIHRoaXMuX3BhZ2VYID0gMFxuICAgIHRoaXMuX3BhZ2VZID0gMFxuICAgIHRoaXMuX29uTGF5b3V0ID0gdGhpcy5fb25MYXlvdXQuYmluZCh0aGlzKVxuICAgIHRoaXMuX29uU1ZhbHVlQ2hhbmdlID0gdGhpcy5fb25TVmFsdWVDaGFuZ2UuYmluZCh0aGlzKVxuICAgIHRoaXMuX29uVlZhbHVlQ2hhbmdlID0gdGhpcy5fb25WVmFsdWVDaGFuZ2UuYmluZCh0aGlzKVxuICAgIHRoaXMuX29uQ29sb3JTZWxlY3RlZCA9IHRoaXMuX29uQ29sb3JTZWxlY3RlZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5fb25PbGRDb2xvclNlbGVjdGVkID0gdGhpcy5fb25PbGRDb2xvclNlbGVjdGVkLmJpbmQodGhpcylcbiAgICB0aGlzLl9pc1JUTCA9IEkxOG5NYW5hZ2VyLmlzUlRMXG4gICAgdGhpcy5fcGlja2VyUmVzcG9uZGVyID0gY3JlYXRlUGFuUmVzcG9uZGVyKHtcbiAgICAgIG9uU3RhcnQ6IHRoaXMuX2hhbmRsZUNvbG9yQ2hhbmdlLFxuICAgICAgb25Nb3ZlOiB0aGlzLl9oYW5kbGVDb2xvckNoYW5nZSxcbiAgICB9KVxuICB9XG5cbiAgX2dldENvbG9yKCkge1xuICAgIGNvbnN0IHBhc3NlZENvbG9yID1cbiAgICAgIHR5cGVvZiB0aGlzLnByb3BzLmNvbG9yID09PSBcInN0cmluZ1wiXG4gICAgICAgID8gdGlueWNvbG9yKHRoaXMucHJvcHMuY29sb3IpLnRvSHN2KClcbiAgICAgICAgOiB0aGlzLnByb3BzLmNvbG9yXG4gICAgcmV0dXJuIHBhc3NlZENvbG9yIHx8IHRoaXMuc3RhdGUuY29sb3JcbiAgfVxuXG4gIF9vbkNvbG9yU2VsZWN0ZWQoKSB7XG4gICAgY29uc3QgeyBvbkNvbG9yU2VsZWN0ZWQgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCBjb2xvciA9IHRpbnljb2xvcih0aGlzLl9nZXRDb2xvcigpKS50b0hleFN0cmluZygpXG4gICAgb25Db2xvclNlbGVjdGVkICYmIG9uQ29sb3JTZWxlY3RlZChjb2xvcilcbiAgfVxuXG4gIF9vbk9sZENvbG9yU2VsZWN0ZWQoKSB7XG4gICAgY29uc3QgeyBvbGRDb2xvciwgb25PbGRDb2xvclNlbGVjdGVkIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgY29sb3IgPSB0aW55Y29sb3Iob2xkQ29sb3IpXG4gICAgdGhpcy5zZXRTdGF0ZSh7IGNvbG9yOiBjb2xvci50b0hzdigpIH0pXG4gICAgb25PbGRDb2xvclNlbGVjdGVkICYmIG9uT2xkQ29sb3JTZWxlY3RlZChjb2xvci50b0hleFN0cmluZygpKVxuICB9XG5cbiAgX29uU1ZhbHVlQ2hhbmdlKHM6IG51bWJlcikge1xuICAgIGNvbnN0IHsgaCwgdiB9ID0gdGhpcy5fZ2V0Q29sb3IoKVxuICAgIHRoaXMuX29uQ29sb3JDaGFuZ2UoeyBoLCBzLCB2IH0pXG4gIH1cblxuICBfb25WVmFsdWVDaGFuZ2UodjogbnVtYmVyKSB7XG4gICAgY29uc3QgeyBoLCBzIH0gPSB0aGlzLl9nZXRDb2xvcigpXG4gICAgdGhpcy5fb25Db2xvckNoYW5nZSh7IGgsIHMsIHYgfSlcbiAgfVxuXG4gIF9vbkNvbG9yQ2hhbmdlKGNvbG9yOiB7IGg6IG51bWJlcjsgczogYW55OyB2OiBhbnkgfSkge1xuICAgIHRoaXMuc2V0U3RhdGUoeyBjb2xvciB9KVxuICAgIGlmICh0aGlzLnByb3BzLm9uQ29sb3JDaGFuZ2UpIHtcbiAgICAgIHRoaXMucHJvcHMub25Db2xvckNoYW5nZShjb2xvcilcbiAgICB9XG4gIH1cblxuICBfb25MYXlvdXQobDoge1xuICAgIG5hdGl2ZUV2ZW50OiB7XG4gICAgICBsYXlvdXQ6IHsgd2lkdGg6IG51bWJlcjsgaGVpZ2h0OiBudW1iZXI7IHg6IG51bWJlcjsgeTogbnVtYmVyIH07XG4gICAgfTtcbiAgfSkge1xuICAgIHRoaXMuX2xheW91dCA9IGwubmF0aXZlRXZlbnQubGF5b3V0XG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLl9sYXlvdXRcbiAgICBjb25zdCBwaWNrZXJTaXplID0gTWF0aC5taW4od2lkdGgsIGhlaWdodClcbiAgICBpZiAodGhpcy5zdGF0ZS5waWNrZXJTaXplICE9PSBwaWNrZXJTaXplKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgcGlja2VyU2l6ZSB9KVxuICAgIH1cbiAgICAvLyBsYXlvdXQueCwgbGF5b3V0LnkgaXMgYWx3YXlzIDBcbiAgICAvLyB3ZSBhbHdheXMgbWVhc3VyZSBiZWNhdXNlIGxheW91dCBpcyB0aGUgc2FtZSBldmVuIHRob3VnaCBwaWNrZXIgaXMgbW92ZWQgb24gdGhlIHBhZ2VcbiAgICBJbnRlcmFjdGlvbk1hbmFnZXIucnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKCkgPT4ge1xuICAgICAgLy8gbWVhc3VyZSBvbmx5IGFmdGVyIChwb3NzaWJsZSkgYW5pbWF0aW9uIGVuZGVkXG4gICAgICB0aGlzLnJlZnMucGlja2VyQ29udGFpbmVyICYmXG4gICAgICAgICh0aGlzLnJlZnMucGlja2VyQ29udGFpbmVyIGFzIGFueSkubWVhc3VyZShcbiAgICAgICAgICAoXG4gICAgICAgICAgICB4OiBudW1iZXIsXG4gICAgICAgICAgICB5OiBudW1iZXIsXG4gICAgICAgICAgICB3aWR0aDogbnVtYmVyLFxuICAgICAgICAgICAgaGVpZ2h0OiBudW1iZXIsXG4gICAgICAgICAgICBwYWdlWDogbnVtYmVyLFxuICAgICAgICAgICAgcGFnZVk6IG51bWJlclxuICAgICAgICAgICkgPT4ge1xuICAgICAgICAgICAgLy8gcGlja2VyIHBvc2l0aW9uIGluIHRoZSBzY3JlZW5cbiAgICAgICAgICAgIHRoaXMuX3BhZ2VYID0gcGFnZVhcbiAgICAgICAgICAgIHRoaXMuX3BhZ2VZID0gcGFnZVlcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICB9KVxuICB9XG5cbiAgX2hhbmRsZUNvbG9yQ2hhbmdlID0gKHsgeCwgeSB9OiBQb2ludDJEKSA9PiB7XG4gICAgY29uc3QgeyBzLCB2IH0gPSB0aGlzLl9nZXRDb2xvcigpXG4gICAgY29uc3QgbWFyZ2luTGVmdCA9ICh0aGlzLl9sYXlvdXQud2lkdGggLSB0aGlzLnN0YXRlLnBpY2tlclNpemUpIC8gMlxuICAgIGNvbnN0IG1hcmdpblRvcCA9ICh0aGlzLl9sYXlvdXQuaGVpZ2h0IC0gdGhpcy5zdGF0ZS5waWNrZXJTaXplKSAvIDJcbiAgICBjb25zdCByZWxhdGl2ZVggPSB4IC0gdGhpcy5fcGFnZVggLSBtYXJnaW5MZWZ0XG4gICAgY29uc3QgcmVsYXRpdmVZID0geSAtIHRoaXMuX3BhZ2VZIC0gbWFyZ2luVG9wXG4gICAgY29uc3QgaCA9IHRoaXMuX2NvbXB1dGVIVmFsdWUocmVsYXRpdmVYLCByZWxhdGl2ZVkpXG4gICAgdGhpcy5fb25Db2xvckNoYW5nZSh7IGgsIHMsIHYgfSlcblxuICAgIHJldHVybiB0cnVlXG4gIH07XG5cbiAgX2NvbXB1dGVIVmFsdWUoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICBjb25zdCBteCA9IHRoaXMuc3RhdGUucGlja2VyU2l6ZSAvIDJcbiAgICBjb25zdCBteSA9IHRoaXMuc3RhdGUucGlja2VyU2l6ZSAvIDJcbiAgICBjb25zdCBkeCA9IHggLSBteFxuICAgIGNvbnN0IGR5ID0geSAtIG15XG4gICAgY29uc3QgcmFkID0gTWF0aC5hdGFuMihkeCwgZHkpICsgTWF0aC5QSSArIE1hdGguUEkgLyAyXG4gICAgcmV0dXJuICgocmFkICogMTgwKSAvIE1hdGguUEkpICUgMzYwXG4gIH1cblxuICBfaFZhbHVlVG9SYWQoZGVnOiBudW1iZXIpIHtcbiAgICBjb25zdCByYWQgPSAoZGVnICogTWF0aC5QSSkgLyAxODBcbiAgICByZXR1cm4gcmFkIC0gTWF0aC5QSSAtIE1hdGguUEkgLyAyXG4gIH1cblxuICBfZ2V0U2xpZGVyKCk6IHR5cGVvZiBTbGlkZXIge1xuICAgIGlmICh0aGlzLnByb3BzLmhpZGVTbGlkZXJzKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgaWYgKHRoaXMucHJvcHMuc2xpZGVyQ29tcG9uZW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5zbGlkZXJDb21wb25lbnQgYXMgYW55XG4gICAgfVxuXG4gICAgaWYgKCFTbGlkZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJZb3UgbmVlZCB0byBpbnN0YWxsIGBAcmVhY3QtbmF0aXZlLWNvbW11bml0eS9zbGlkZXJgIGFuZCBwYXNzIGl0IChvciBhbnkgb3RoZXIgU2xpZGVyIGNvbXBhdGlibGUgY29tcG9uZW50KSBhcyBgc2xpZGVyQ29tcG9uZW50YCBwcm9wXCJcbiAgICAgIClcbiAgICB9XG5cbiAgICByZXR1cm4gU2xpZGVyXG4gIH1cblxuICBnZXRDb2xvcigpIHtcbiAgICByZXR1cm4gdGlueWNvbG9yKHRoaXMuX2dldENvbG9yKCkpLnRvSGV4U3RyaW5nKClcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHBpY2tlclNpemUgfSA9IHRoaXMuc3RhdGVcbiAgICBjb25zdCB7IG9sZENvbG9yLCBzdHlsZSB9ID0gdGhpcy5wcm9wc1xuXG4gICAgY29uc3QgY29sb3IgPSB0aGlzLl9nZXRDb2xvcigpXG4gICAgY29uc3QgeyBoLCBzLCB2IH0gPSBjb2xvclxuICAgIGNvbnN0IGFuZ2xlID0gdGhpcy5faFZhbHVlVG9SYWQoaClcbiAgICBjb25zdCBzZWxlY3RlZENvbG9yID0gdGlueWNvbG9yKGNvbG9yKS50b0hleFN0cmluZygpXG4gICAgY29uc3QgaW5kaWNhdG9yQ29sb3IgPSB0aW55Y29sb3IoeyBoLCBzOiAxLCB2OiAxIH0pLnRvSGV4U3RyaW5nKClcblxuICAgIGNvbnN0IGNvbXB1dGVkID0gbWFrZUNvbXB1dGVkU3R5bGVzKHtcbiAgICAgIHBpY2tlclNpemUsXG4gICAgICBzZWxlY3RlZENvbG9yLFxuICAgICAgaW5kaWNhdG9yQ29sb3IsXG4gICAgICBvbGRDb2xvcixcbiAgICAgIGFuZ2xlLFxuICAgICAgaXNSVEw6IHRoaXMuX2lzUlRMLFxuICAgIH0pXG5cbiAgICBjb25zdCBTbGlkZXJDb21wID0gdGhpcy5fZ2V0U2xpZGVyKClcblxuICAgIHJldHVybiAoXG4gICAgICA8VmlldyBzdHlsZT17c3R5bGV9PlxuICAgICAgICA8Vmlld1xuICAgICAgICAgIG9uTGF5b3V0PXt0aGlzLl9vbkxheW91dH1cbiAgICAgICAgICByZWY9XCJwaWNrZXJDb250YWluZXJcIlxuICAgICAgICAgIHN0eWxlPXtzdHlsZXMucGlja2VyQ29udGFpbmVyfVxuICAgICAgICA+XG4gICAgICAgICAgeyFwaWNrZXJTaXplID8gbnVsbCA6IChcbiAgICAgICAgICAgIDxWaWV3PlxuICAgICAgICAgICAgICA8Vmlld1xuICAgICAgICAgICAgICAgIHsuLi50aGlzLl9waWNrZXJSZXNwb25kZXIucGFuSGFuZGxlcnN9XG4gICAgICAgICAgICAgICAgc3R5bGU9e1tjb21wdXRlZC5waWNrZXJdfVxuICAgICAgICAgICAgICAgIGNvbGxhcHNhYmxlPXtmYWxzZX1cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxJbWFnZVxuICAgICAgICAgICAgICAgICAgc291cmNlPXtyZXF1aXJlKFwiLi4vcmVzb3VyY2VzL2NvbG9yLWNpcmNsZS5wbmdcIil9XG4gICAgICAgICAgICAgICAgICByZXNpemVNb2RlPVwiY29udGFpblwiXG4gICAgICAgICAgICAgICAgICBzdHlsZT17W3N0eWxlcy5waWNrZXJJbWFnZV19XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8Vmlld1xuICAgICAgICAgICAgICAgICAgc3R5bGU9e1tzdHlsZXMucGlja2VySW5kaWNhdG9yLCBjb21wdXRlZC5waWNrZXJJbmRpY2F0b3JdfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgIDwvVmlldz5cbiAgICAgICAgICAgICAge29sZENvbG9yICYmIChcbiAgICAgICAgICAgICAgICA8VG91Y2hhYmxlT3BhY2l0eVxuICAgICAgICAgICAgICAgICAgc3R5bGU9e1tzdHlsZXMuc2VsZWN0ZWRQcmV2aWV3LCBjb21wdXRlZC5zZWxlY3RlZFByZXZpZXddfVxuICAgICAgICAgICAgICAgICAgb25QcmVzcz17dGhpcy5fb25Db2xvclNlbGVjdGVkfVxuICAgICAgICAgICAgICAgICAgYWN0aXZlT3BhY2l0eT17MC43fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgIHtvbGRDb2xvciAmJiAoXG4gICAgICAgICAgICAgICAgPFRvdWNoYWJsZU9wYWNpdHlcbiAgICAgICAgICAgICAgICAgIHN0eWxlPXtbc3R5bGVzLm9yaWdpbmFsUHJldmlldywgY29tcHV0ZWQub3JpZ2luYWxQcmV2aWV3XX1cbiAgICAgICAgICAgICAgICAgIG9uUHJlc3M9e3RoaXMuX29uT2xkQ29sb3JTZWxlY3RlZH1cbiAgICAgICAgICAgICAgICAgIGFjdGl2ZU9wYWNpdHk9ezAuN31cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICB7IW9sZENvbG9yICYmIChcbiAgICAgICAgICAgICAgICA8VG91Y2hhYmxlT3BhY2l0eVxuICAgICAgICAgICAgICAgICAgc3R5bGU9e1tcbiAgICAgICAgICAgICAgICAgICAgc3R5bGVzLnNlbGVjdGVkRnVsbFByZXZpZXcsXG4gICAgICAgICAgICAgICAgICAgIGNvbXB1dGVkLnNlbGVjdGVkRnVsbFByZXZpZXcsXG4gICAgICAgICAgICAgICAgICBdfVxuICAgICAgICAgICAgICAgICAgb25QcmVzcz17dGhpcy5fb25Db2xvclNlbGVjdGVkfVxuICAgICAgICAgICAgICAgICAgYWN0aXZlT3BhY2l0eT17MC43fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICA8L1ZpZXc+XG4gICAgICAgICAgKX1cbiAgICAgICAgPC9WaWV3PlxuICAgICAgICB7dGhpcy5wcm9wcy5oaWRlU2xpZGVycyA/IG51bGwgOiAoXG4gICAgICAgICAgPFZpZXc+XG4gICAgICAgICAgICA8U2xpZGVyQ29tcCB2YWx1ZT17c30gb25WYWx1ZUNoYW5nZT17dGhpcy5fb25TVmFsdWVDaGFuZ2V9IC8+XG4gICAgICAgICAgICA8U2xpZGVyQ29tcCB2YWx1ZT17dn0gb25WYWx1ZUNoYW5nZT17dGhpcy5fb25WVmFsdWVDaGFuZ2V9IC8+XG4gICAgICAgICAgPC9WaWV3PlxuICAgICAgICApfVxuICAgICAgPC9WaWV3PlxuICAgIClcbiAgfVxufVxuXG5jb25zdCBtYWtlQ29tcHV0ZWRTdHlsZXMgPSAoe1xuICBpbmRpY2F0b3JDb2xvcixcbiAgc2VsZWN0ZWRDb2xvcixcbiAgb2xkQ29sb3IsXG4gIGFuZ2xlLFxuICBwaWNrZXJTaXplLFxuICBpc1JUTCxcbn0pID0+IHtcbiAgY29uc3Qgc3VtbWFyeVNpemUgPSAwLjUgKiBwaWNrZXJTaXplXG4gIGNvbnN0IGluZGljYXRvclBpY2tlclJhdGlvID0gNDIgLyA1MTAgLy8gY29tcHV0ZWQgZnJvbSBwaWNrZXIgaW1hZ2VcbiAgY29uc3QgaW5kaWNhdG9yU2l6ZSA9IGluZGljYXRvclBpY2tlclJhdGlvICogcGlja2VyU2l6ZVxuICBjb25zdCBwaWNrZXJQYWRkaW5nID0gaW5kaWNhdG9yU2l6ZSAvIDNcbiAgY29uc3QgaW5kaWNhdG9yUmFkaXVzID0gcGlja2VyU2l6ZSAvIDIgLSBpbmRpY2F0b3JTaXplIC8gMiAtIHBpY2tlclBhZGRpbmdcbiAgY29uc3QgbXggPSBwaWNrZXJTaXplIC8gMlxuICBjb25zdCBteSA9IHBpY2tlclNpemUgLyAyXG4gIGNvbnN0IGR4ID0gTWF0aC5jb3MoYW5nbGUpICogaW5kaWNhdG9yUmFkaXVzXG4gIGNvbnN0IGR5ID0gTWF0aC5zaW4oYW5nbGUpICogaW5kaWNhdG9yUmFkaXVzXG4gIHJldHVybiB7XG4gICAgcGlja2VyOiB7XG4gICAgICBwYWRkaW5nOiBwaWNrZXJQYWRkaW5nLFxuICAgICAgd2lkdGg6IHBpY2tlclNpemUsXG4gICAgICBoZWlnaHQ6IHBpY2tlclNpemUsXG4gICAgfSxcbiAgICBwaWNrZXJJbmRpY2F0b3I6IHtcbiAgICAgIHRvcDogbXggKyBkeCAtIGluZGljYXRvclNpemUgLyAyLFxuICAgICAgW2lzUlRMID8gXCJyaWdodFwiIDogXCJsZWZ0XCJdOiBteSArIGR5IC0gaW5kaWNhdG9yU2l6ZSAvIDIsXG4gICAgICB3aWR0aDogaW5kaWNhdG9yU2l6ZSxcbiAgICAgIGhlaWdodDogaW5kaWNhdG9yU2l6ZSxcbiAgICAgIGJvcmRlclJhZGl1czogaW5kaWNhdG9yU2l6ZSAvIDIsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6IGluZGljYXRvckNvbG9yLFxuICAgIH0sXG4gICAgc2VsZWN0ZWRQcmV2aWV3OiB7XG4gICAgICB3aWR0aDogc3VtbWFyeVNpemUgLyAyLFxuICAgICAgaGVpZ2h0OiBzdW1tYXJ5U2l6ZSxcbiAgICAgIHRvcDogcGlja2VyU2l6ZSAvIDIgLSBzdW1tYXJ5U2l6ZSAvIDIsXG4gICAgICBsZWZ0OiBNYXRoLmZsb29yKHBpY2tlclNpemUgLyAyKSxcbiAgICAgIGJvcmRlclRvcFJpZ2h0UmFkaXVzOiBzdW1tYXJ5U2l6ZSAvIDIsXG4gICAgICBib3JkZXJCb3R0b21SaWdodFJhZGl1czogc3VtbWFyeVNpemUgLyAyLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiBzZWxlY3RlZENvbG9yLFxuICAgIH0sXG4gICAgb3JpZ2luYWxQcmV2aWV3OiB7XG4gICAgICB3aWR0aDogTWF0aC5jZWlsKHN1bW1hcnlTaXplIC8gMiksXG4gICAgICBoZWlnaHQ6IHN1bW1hcnlTaXplLFxuICAgICAgdG9wOiBwaWNrZXJTaXplIC8gMiAtIHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGxlZnQ6IHBpY2tlclNpemUgLyAyIC0gc3VtbWFyeVNpemUgLyAyLFxuICAgICAgYm9yZGVyVG9wTGVmdFJhZGl1czogc3VtbWFyeVNpemUgLyAyLFxuICAgICAgYm9yZGVyQm90dG9tTGVmdFJhZGl1czogc3VtbWFyeVNpemUgLyAyLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiBvbGRDb2xvcixcbiAgICB9LFxuICAgIHNlbGVjdGVkRnVsbFByZXZpZXc6IHtcbiAgICAgIHdpZHRoOiBzdW1tYXJ5U2l6ZSxcbiAgICAgIGhlaWdodDogc3VtbWFyeVNpemUsXG4gICAgICB0b3A6IHBpY2tlclNpemUgLyAyIC0gc3VtbWFyeVNpemUgLyAyLFxuICAgICAgbGVmdDogcGlja2VyU2l6ZSAvIDIgLSBzdW1tYXJ5U2l6ZSAvIDIsXG4gICAgICBib3JkZXJSYWRpdXM6IHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGJhY2tncm91bmRDb2xvcjogc2VsZWN0ZWRDb2xvcixcbiAgICB9LFxuICB9XG59XG5cbmNvbnN0IHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHtcbiAgcGlja2VyQ29udGFpbmVyOiB7XG4gICAgZmxleDogMSxcbiAgICBhbGlnbkl0ZW1zOiBcImNlbnRlclwiLFxuICAgIGp1c3RpZnlDb250ZW50OiBcImNlbnRlclwiLFxuICB9LFxuICBwaWNrZXJJbWFnZToge1xuICAgIGZsZXg6IDEsXG4gICAgd2lkdGg6IG51bGwsXG4gICAgaGVpZ2h0OiBudWxsLFxuICB9LFxuICBwaWNrZXJJbmRpY2F0b3I6IHtcbiAgICBwb3NpdGlvbjogXCJhYnNvbHV0ZVwiLFxuICAgIC8vIFNoYWRvdyBvbmx5IHdvcmtzIG9uIGlPUy5cbiAgICBzaGFkb3dDb2xvcjogXCJibGFja1wiLFxuICAgIHNoYWRvd09wYWNpdHk6IDAuMyxcbiAgICBzaGFkb3dPZmZzZXQ6IHsgd2lkdGg6IDMsIGhlaWdodDogMyB9LFxuICAgIHNoYWRvd1JhZGl1czogNCxcblxuICAgIC8vIFRoaXMgd2lsbCBlbGV2YXRlIHRoZSB2aWV3IG9uIEFuZHJvaWQsIGNhdXNpbmcgc2hhZG93IHRvIGJlIGRyYXduLlxuICAgIGVsZXZhdGlvbjogNSxcbiAgfSxcbiAgc2VsZWN0ZWRQcmV2aWV3OiB7XG4gICAgcG9zaXRpb246IFwiYWJzb2x1dGVcIixcbiAgICBib3JkZXJMZWZ0V2lkdGg6IDAsXG4gIH0sXG4gIG9yaWdpbmFsUHJldmlldzoge1xuICAgIHBvc2l0aW9uOiBcImFic29sdXRlXCIsXG4gICAgYm9yZGVyUmlnaHRXaWR0aDogMCxcbiAgfSxcbiAgc2VsZWN0ZWRGdWxsUHJldmlldzoge1xuICAgIHBvc2l0aW9uOiBcImFic29sdXRlXCIsXG4gIH0sXG4gIHBpY2tlckFsaWdubWVudDoge1xuICAgIGFsaWduSXRlbXM6IFwiY2VudGVyXCIsXG4gIH0sXG59KVxuIl19